# כללי מערכת הצ'אט - הערכת מצב נוכחי

## הערכת מצב נוכחי

### מה קיים היום

1. **זרימת יצירת משימה (add_task)**:
   - ✅ כותרת ועדיפות מאומתות כחובה לפני ביצוע
   - ✅ זרימת עבודה שואלת: כותרת → עדיפות → תאריך יעד
   - ✅ תאריך יעד נשאל כחלק מהזרימה
   - ✅ ביצוע מתרחש רק כאשר `ready=true`, `confidence>=0.8`, ושני השדות כותרת ועדיפות קיימים
   - ✅ לוגיקת ניקוי JSON קיימת כדי למנוע הופעת JSON ב-UI של הצ'אט

2. **זיהוי כוונה (Intent Detection)**:
   - ✅ המערכת יכולה לזהות: list_tasks, task_insights, potential_create, potential_update, potential_delete
   - ✅ קיים fallback מבוסס כללים כאשר LLM לא זמין
   - ✅ אינטגרציה עם LLM עם פורמט מובנה (REPLY + COMMAND)

3. **זרימת נתונים**:
   - ✅ משימות נוכחיות נשלפות מה-database ונשלחות ל-chatbot-service בכל בקשה
   - ✅ היסטוריית שיחה נשלחת מה-frontend ל-backend
   - ✅ הוראות ב-prompt קיימות להעדיף נתוני משימות נוכחיים על פני היסטוריה

4. **טיפול בכוונות עדכון/מחיקה**:
   - ✅ המערכת יכולה לזהות כוונות עדכון/מחיקה
   - ✅ המערכת שואלת להבהרה (איזו משימה, איזה שדה)
   - ⚠️ המערכת שואלת "האם אתה מוכן?" אבל אין אישור מפורש שחוסם

### מה לא קיים היום

1. **ביצוע עדכון/מחיקה**:
   - ❌ אין לוגיקת ביצוע עבור `update_task` או `delete_task` ב-`core-api/app/chat/service.py`
   - ❌ רק `add_task` מבוצע דרך הצ'אט
   - ❌ פעולות עדכון/מחיקה מטופלות רק דרך API endpoints ישירים, לא דרך הצ'אט

2. **ניקוי היסטוריית צ'אט**:
   - ❌ היסטוריית צ'אט לא מתנקה אחרי פעולות CRUD
   - ❌ `localStorage` שומר היסטוריה אחרי מוטציות משימות
   - ❌ מצב `messages` ב-ChatWidget לא מתאפס אחרי CRUD
   - ❌ רק כפתור "Clear" ידני מנקה היסטוריה

3. **אימות תאריך**:
   - ❌ אין אימות שמחייב שתאריך חייב להיות מספרי או "אין" מפורש לפני ביצוע
   - ❌ המערכת מנסה לפרסר תאריך, ואם זה נכשל, מגדירה ל-`None` בלי לשאול שוב
   - ❌ אין ערובה ששאלת התאריך היא השלב האחרון המוחלט לפני ביצוע

4. **זרימות אישור**:
   - ❌ אין שלב אישור מפורש שחוסם ביצוע עבור עדכונים
   - ❌ אין שלב אישור מפורש שחוסם ביצוע עבור מחיקות
   - ⚠️ המערכת שואלת "האם אתה בטוח?" אבל לא מחכה לאישור מפורש לפני המשך

5. **זרימת עדכון ספציפית לשדה**:
   - ❌ המערכת לא שואלת מפורשות "איזה שדה תרצה לעדכן?" לפני איסוף שינויים
   - ⚠️ המערכת אוספת כותרת, עדיפות, תאריך יעד אבל לא מבהירה איזה שדה ספציפי משתנה

---

## גורמים חוסמים (מושגיים/מערכתיים)

### כלל 1: שדות חובה והבנת תאריך
**סטטוס**: ⚠️ מסופק חלקית

**גורמים חוסמים**:
- אימות תאריך לא נאכף: המערכת מקבלת כל ערך תאריך, מנסה לפרסר, ואם הפרסור נכשל, מגדירה בשקט ל-`None` בלי לשאול שוב בפורמט מספרי
- עבור עדכונים: המערכת לא שואלת מפורשות "איזה שדה תרצה לעדכן?" - היא מניחה שכל השדות (כותרת, עדיפות, תאריך יעד) צריכים להיאסף
- אין שמירה על אימות שמונעת ביצוע אם תאריך לא ברור (למשל, "יום רביעי" בלי הקשר)

### כלל 2: תאריך כשלב אחרון
**סטטוס**: ⚠️ מסופק חלקית

**גורמים חוסמים**:
- הזרימה שואלת על תאריך יעד, אבל אין ערובה שזה השלב האחרון המוחלט
- הדגל `ready` יכול להיות מוגדר ל-`true` גם אם תאריך יעד לא נשאל מפורשות בשיחה הנוכחית (אם נשאל בהיסטוריה)
- אין שמירה מפורשת שמונעת ביצוע עד ששאלת התאריך נענתה

### כלל 3: דרישת בהירות תאריך
**סטטוס**: ❌ לא מסופק

**גורמים חוסמים**:
- אין לוגיקת אימות שבודקת אם תאריך הוא מספרי או "אין" מפורש לפני ביצוע
- הוראות ב-prompt קיימות אבל לא נאכפות בקוד
- המערכת יכולה להמשיך עם `deadline=None` גם אם המשתמש נתן טקסט תאריך לא ברור
- אין מנגנון לשאול שוב אם פרסור תאריך נכשל

### כלל 4: ניקוי היסטוריית צ'אט אחרי CRUD
**סטטוס**: ❌ לא מסופק

**גורמים חוסמים**:
- אין ניקוי אוטומטי של מצב `messages` ב-ChatWidget אחרי CRUD
- אין ניקוי אוטומטי של `localStorage` אחרי CRUD
- היסטוריה נשארת בין פעולות CRUD
- רק כפתור "Clear" ידני מנקה היסטוריה
- אירוע `taskMutated` מפעיל רענון אבל לא מנקה היסטוריית צ'אט

### כלל 5: היסטוריה ריקה = הסתמכות רק על נתוני משימות
**סטטוס**: ⚠️ מסופק חלקית

**גורמים חוסמים**:
- היסטוריה תמיד נשלחת (אפילו אם מערך ריק) - המערכת לא פועלת במצב "היסטוריה ריקה באמת" אחרי CRUD
- ה-prompt מורה להעדיף tasks_data, אבל היסטוריה עדיין קיימת ויכולה להשפיע על החלטות
- אין מנגנון לנקות היסטוריה מ-localStorage אחרי CRUD, אז היסטוריה לעולם לא באמת ריקה
- המערכת לא מבחינה בין "סשן חדש" (היסטוריה ריקה) ל-"אחרי CRUD" (צריכה להיות ריקה אבל לא)

### כלל 6: אין JSON ב-UI של צ'אט
**סטטוס**: ✅ מסופק

**גורמים חוסמים**: אין - לוגיקת ניקוי JSON קיימת ועובדת

### כלל 7: הבנת כוונה עבור LIST/GET
**סטטוס**: ⚠️ מסופק חלקית

**גורמים חוסמים**:
- המערכת יכולה לזהות כוונת list_tasks
- המערכת מקבלת tasks_data עם כל השדות (עדיפות, סטטוס, תאריך יעד)
- ה-prompt מורה לסנן לפי שדות, אבל אין אימות מפורש שכל שדות המשימות נחשבים
- אין בדיקה מפורשת שמאשרת שסינון עובד עבור כל שדות המשימות

### כלל 8: אישור עדכון
**סטטוס**: ❌ לא מסופק

**גורמים חוסמים**:
- ביצוע עדכון לא קיים בזרימת הצ'אט (רק `add_task` מבוצע)
- גם אם היה קיים, אין שלב אישור מפורש שחוסם ביצוע
- המערכת שואלת "האם אתה מוכן?" אבל לא מחכה לתשובה מפורשת "כן/אשר" לפני המשך
- אין כוונת/מצב אישור שמונע ביצוע עד לאישור

### כלל 9: אישור מחיקה
**סטטוס**: ❌ לא מסופק

**גורמים חוסמים**:
- ביצוע מחיקה לא קיים בזרימת הצ'אט
- גם אם היה קיים, אין שלב אישור מפורש שחוסם ביצוע
- המערכת שואלת "האם אתה בטוח?" אבל לא מחכה לתשובה מפורשת "כן/אשר" לפני המשך
- אין כוונת/מצב אישור שמונע ביצוע עד לאישור
- המערכת לא מציגה תיאור משימה בבירור לפני בקשת אישור

---

## ניתוח מפורט של כללים

### כלל 1: שדות חובה - שם משימה ועדיפות
**סטטוס**: ⚠️ מסופק חלקית

**מה עובד**:
- כותרת ועדיפות מאומתות לפני ביצוע `add_task` (שורה 129 ב-`core-api/app/chat/service.py`)
- אימות מחייב ששני השדות חייבים להיות קיימים
- המערכת שואלת על שני השדות ברצף

**מה חוסם סיפוק מלא**:
- שדה תאריך: אין אימות שתאריך חייב להיות "אין" (מפורש) או מספרי לפני ביצוע
- עבור עדכונים: המערכת לא שואלת מפורשות "איזה שדה משתנה?" - היא אוספת את כל השדות
- אין אימות שמונע ביצוע אם תאריך לא ברור

### כלל 2: תאריך כשלב אחרון לפני CRUD
**סטטוס**: ⚠️ מסופק חלקית

**מה עובד**:
- סדר זרימה: כותרת → עדיפות → תאריך יעד
- תאריך יעד נשאל בזרימה

**מה חוסם סיפוק מלא**:
- אין ערובה ששאלת תאריך יעד היא השלב האחרון המוחלט
- דגל `ready` יכול להיות מוגדר ל-`true` גם אם תאריך יעד לא נשאל מפורשות בתור הנוכחי (אם נשאל בהיסטוריה)
- אין שמירה מפורשת שמונעת ביצוע עד ששאלת התאריך נענתה

### כלל 3: אם תאריך לא ברור, לשאול בפורמט מספרי
**סטטוס**: ❌ לא מסופק

**מה עובד**:
- הוראות ב-prompt קיימות לשאול בפורמט מספרי אם לא ברור
- ה-prompt מזהיר מפני שימוש בתאריכים ישנים

**מה חוסם סיפוק**:
- אין אימות קוד שמחייב את הכלל הזה
- המערכת מנסה לפרסר תאריך, ואם זה נכשל, מגדירה ל-`None` בלי לשאול שוב
- אין מנגנון לזהות "תאריך לא ברור" ולחסום ביצוע עד הבהרה

### כלל 4: ניקוי היסטוריית צ'אט אחרי CRUD
**סטטוס**: ❌ לא מסופק

**מה עובד**:
- כפתור "Clear" ידני קיים
- אירוע `taskMutated` נשלח אחרי CRUD

**מה חוסם סיפוק**:
- אין ניקוי אוטומטי של מצב `messages` אחרי CRUD
- אין ניקוי אוטומטי של `localStorage` אחרי CRUD
- היסטוריה נשארת בין פעולות CRUD
- המערכת לא מתאפסת למצב "היסטוריה ריקה" אחרי מוטציות

### כלל 5: היסטוריה ריקה = הסתמכות רק על נתוני משימות
**סטטוס**: ⚠️ מסופק חלקית

**מה עובד**:
- משימות נוכחיות תמיד נשלפות מה-database
- ה-prompt מורה להעדיף tasks_data על פני היסטוריה

**מה חוסם סיפוק מלא**:
- היסטוריה לעולם לא באמת ריקה אחרי CRUD (לא מתנקה)
- היסטוריה תמיד נשלחת (אפילו אם מערך ריק), אז המערכת לא פועלת במצב "ריקה באמת"
- אין הבחנה בין "סשן חדש" ל-"אחרי CRUD" states

### כלל 6: לעולם לא לשלוח JSON ב-UI של צ'אט
**סטטוס**: ✅ מסופק

**מה עובד**:
- לוגיקת ניקוי JSON קיימת (`_parse_llm_response` שורות 916-932)
- דפוסי regex מסירים JSON מתשובות
- ניקוי fallback אם JSON דולף לתשובה

**גורמים חוסמים**: אין

### כלל 7: הבנת כוונה נכונה עבור LIST/GET
**סטטוס**: ⚠️ מסופק חלקית

**מה עובד**:
- המערכת יכולה לזהות כוונת `list_tasks`
- נתוני משימות כוללים את כל השדות (עדיפות, סטטוס, תאריך יעד, וכו')
- ה-prompt מורה לסנן לפי שדות

**מה חוסם סיפוק מלא**:
- אין אימות מפורש שכל שדות המשימות נחשבים בסינון
- אין בדיקה שמאשרת שסינון עובד נכון עבור כל השדות
- זיהוי כוונה לא תמיד מסווג נכון LIST מול כוונות אחרות

### כלל 8: אישור עדכון
**סטטוס**: ❌ לא מסופק

**מה עובד**:
- המערכת יכולה לזהות כוונת עדכון
- המערכת שואלת לזיהוי משימה ושדות

**מה חוסם סיפוק**:
- ביצוע עדכון לא קיים בזרימת הצ'אט (רק `add_task` מבוצע)
- אין שלב אישור מפורש ("אשר עדכון?") שחוסם ביצוע
- המערכת שואלת "האם אתה מוכן?" אבל לא דורשת תשובה מפורשת "כן/אשר"
- אין מצב/כוונת אישור שמונע ביצוע עד לאישור

### כלל 9: אישור מחיקה
**סטטוס**: ❌ לא מסופק

**מה עובד**:
- המערכת יכולה לזהות כוונת מחיקה
- המערכת שואלת "האם אתה בטוח?" במקרים מסוימים

**מה חוסם סיפוק**:
- ביצוע מחיקה לא קיים בזרימת הצ'אט
- אין שלב אישור מפורש שחוסם ביצוע
- המערכת לא תמיד מציגה תיאור משימה בבירור לפני בקשת אישור
- אין מצב/כוונת אישור שמונע ביצוע עד לאישור

---

## כללים (מילה במילה)

### כלל 1: שדות חובה
שם משימה ושדה עדיפות הם חובה.
- שדה תאריך הוא חובה להיות מובן כ:
  - אין (המשתמש מפורשות לא רוצה תאריך), או
  - תאריך מספרי.
- אין פעולת CRUD (הוספה / עדכון / שינוי) מותרת אלא אם:
  - שם משימה ועדיפות שניהם קיימים.
- עבור עדכונים, המערכת חייבת להבין בדיוק איזה שדה משתנה.
- אין CRUD מותר בלי לעמוד בכל האמור לעיל.

### כלל 2: תאריך כשלב אחרון
השלב האחרון לפני כל פעולת CRUD (הוספה / עדכון / מחיקה) חייב להיות שאלה על התאריך.

### כלל 3: בהירות תאריך
אם המערכת לא מבינה האם המשתמש רוצה תאריך, או שהתאריך עצמו לא ברור (למשל טקסט חופשי במקום מספרים), היא חייבת לשאול מפורשות את התאריך בפורמט מספרי. הבנת התאריך (או "אין" מפורש) היא חובה.

### כלל 4: ניקוי היסטוריה אחרי CRUD
אחרי כל פעולת CRUD (הוספה / עדכון / מחיקה), היסטוריית הצ'אט חייבת להתנקות מיד דרך רענון דף.

### כלל 5: התנהגות היסטוריה ריקה
כאשר היסטוריית צ'אט ריקה:
- המערכת חייבת להסתמך רק על קבוצת המשימות הנוכחית.
- זה חייב לקרות אחרי כל פעולת CRUD בצד השרת: POST / PATCH / PUT / DELETE.
- היסטוריית צ'אט חייבת להתנקות גם מ-localStorage.
- זרימת איפוס זו היא חובה ומתרחשת כל פעם.
- התנהגות זו שווה ערך להתנתקות והתחלת סשן חדש.

### כלל 6: אין JSON ב-UI
הצ'אטבוט לא יכול לשלוח תשובות JSON ב-UI של הצ'אט.
- רק תשובות טקסט קריאות לאדם מותרות.

### כלל 7: הבנת כוונה
הצ'אטבוט חייב להבין נכון כוונה ולהתאים התנהגות בהתאם.
- עבור כוונות LIST / GET בלבד:
  - הוא חייב לסווג ולסנן משימות לפי כל שדות המשימה (עדיפות, סטטוס, תאריך, וכו').
- כלל זה חל רק על כוונות לא-CRUD.

### כלל 8: אישור עדכון
כאשר המערכת מבינה שהמשתמש רוצה לעדכן משימה קיימת:
א) היא חייבת לשאול איזה שדה המשתמש רוצה לעדכן.
ב) אחרי איסוף השינוי, השלב האחרון לפני ביצוע העדכון חייב להיות: בקשת אישור מפורשת (למשל "אשר עדכון?").
ג) רק אחרי אישור ניתן לבצע את העדכון.

### כלל 9: אישור מחיקה
לפני מחיקת משימה:
א) המערכת חייבת להציג את תיאור המשימה בבירור.
ב) השלב האחרון לפני מחיקה חייב להיות: בקשת אישור מפורשת (למשל "אשר מחיקה?").
ג) מחיקה לא יכולה להתרחש בלי אישור.

### כלל זרימה גלובלי חשוב
כל פעולה שאינה פעולת GET/LIST חייבת לעקוב אחרי זרימה קפדנית:
הבהרה → פתרון תאריך → אישור → ביצוע → איפוס מיידי של היסטוריית צ'אט + ניקוי localStorage.
- אחרי איפוס, המערכת מתחילה ממצב נקי ומסתמכת רק על payload המשימות הנוכחי.
